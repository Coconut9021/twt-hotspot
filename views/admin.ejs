<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <link rel="stylesheet" href="/css/admin.css">
    <title>Wi-Fi Access Portal</title>
</head>
<body>
    <table id="clients">
        <tr>
            <th>Full name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Company</th>
            <th>Terms</th>
            <th>Marketing</th>
            <th></th>
        </tr>
        <% data.forEach((row, index) => { %>
            <tr>
                <td><%= row.fullName %></td>
                <td><%= row.email %></td>
                <td><%= row.phone %></td>
                <td><%= row.company %></td>
                <td><%= row.terms %></td>
                <td><%= row.marketing %></td>
                <td>
                    <div class="dropdown">
                        <div class="menu-btn">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="12" cy="6" r="2" fill="#666666"/>
                                <circle cx="12" cy="12" r="2" fill="#666666"/>
                                <circle cx="12" cy="18" r="2" fill="#666666"/>
                            </svg>
                        </div>
                        <div class="dropdown-content">
                            <a href="#">Link 1</a>
                            <a href="#">Link 2</a>
                            <a href="#" class="delete-link" data-name="<%= row.fullName %>" data-email="<%= row.email %>">Delete</a>
                        </div>
                    </div>
                </td>
            </tr>
        <% }) %> 
    </table>

    <!-- Modal placed outside the table -->
    <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5">Are you sure you want to proceed</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <strong>Warning!</strong> You are about to permanently delete <strong id="userToDelete"></strong>'s data.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete User</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS  -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>
    
    <script> 
        console.log('Script starting...');
        
        let userToDelete = null;

        // Wait for DOM to load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, setting up event listeners...');
            
            // Handle delete button clicks
            document.addEventListener('click', function(e) {
                console.log('Click detected on:', e.target.tagName, e.target.className);
                
                if (e.target.classList.contains('delete-link')) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    console.log('Delete link clicked!');
                    
                    const fullName = e.target.dataset.name;
                    const email = e.target.dataset.email;
                    
                    console.log('User data:', { fullName, email });
                    
                    userToDelete = { fullName, email };
                    document.getElementById('userToDelete').textContent = fullName;
                    
                    // Show modal - using the correct ID
                    console.log('Attempting to show modal...');
                    const modalElement = document.getElementById('staticBackdrop');
                    console.log('Modal element found:', modalElement);
                    
                    if (modalElement) {
                        const modal = new bootstrap.Modal(modalElement);
                        modal.show();
                        console.log('Modal.show() called');
                    } else {
                        console.error('Modal element not found!');
                    }
                }
            });

            // Handle confirm delete
            document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
                console.log('Confirm delete clicked');
                if (!userToDelete) return;
                
                try {
                    const response = await fetch('/delete-user', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(userToDelete)
                    });

                    const result = await response.json();

                    if (result.success) {
                        const modalInstance = bootstrap.Modal.getInstance(document.getElementById('staticBackdrop'));
                        if (modalInstance) {
                            modalInstance.hide();
                        }
                        alert('User deleted successfully!');
                        location.reload();
                    } else {
                        alert('Error deleting user: ' + result.error);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('An error occurred while deleting the user.');
                }
            });
            
            // Handle dropdown menu functionality
            const menuBtns = document.querySelectorAll('.dropdown');
            console.log('Found dropdowns:', menuBtns.length);

            menuBtns.forEach(dropdown => {
                const btn = dropdown.querySelector('.menu-btn');
                const dropdownContent = dropdown.querySelector('.dropdown-content');
                
                if (btn && dropdownContent) {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        console.log('Dropdown menu clicked');
                        
                        // Close all other dropdowns first
                        document.querySelectorAll('.dropdown-content').forEach(content => {
                            if (content !== dropdownContent) {
                                content.style.display = 'none';
                            }
                        });
                        
                        // Toggle current dropdown
                        if (dropdownContent.style.display === 'block') {
                            dropdownContent.style.display = 'none';
                        } else {
                            dropdownContent.style.display = 'block';
                        }
                    });
                }
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.classList.contains('delete-link')) {
                    document.querySelectorAll('.dropdown-content').forEach(dropdown => {
                        dropdown.style.display = 'none';
                    });
                }
            });

            // Prevent dropdown from closing when clicking inside it
            document.querySelectorAll('.dropdown-content').forEach(dropdown => {
                dropdown.addEventListener('click', function(e) {
                    if (!e.target.classList.contains('delete-link')) {
                        e.stopPropagation();
                    }
                });
            });
            
            console.log('All event listeners set up successfully');
        });
    </script>
</body>
</html>